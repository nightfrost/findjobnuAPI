name: .FindJob.nu CI/CD Pipeline

on:
  push:
    branches: [ "master" ] 
  pull_request:
    branches: [ "master" ] 


jobs:
  build:
    runs-on: ubuntu-latest
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: ${{ secrets.MSSQL_SA_PASSWORD }}
          ACCEPT_EULA: Y
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${{ secrets.MSSQL_SA_PASSWORD }} -Q 'SELECT 1' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x 

      - name: Initialize MSSQL database and user
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for SQL Server to be ready..."
          for i in {1..60}; do
            if /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${{ secrets.MSSQL_SA_PASSWORD }}" -Q "SELECT 1" >/dev/null 2>&1; then
              break
            fi
            sleep 2
          done
          /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${{ secrets.MSSQL_SA_PASSWORD }}" -Q "IF DB_ID('JobScraperDB') IS NULL CREATE DATABASE JobScraperDB;"
          /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${{ secrets.MSSQL_SA_PASSWORD }}" -Q "IF NOT EXISTS (SELECT 1 FROM sys.sql_logins WHERE name = 'findjobnusystem') BEGIN CREATE LOGIN findjobnusystem WITH PASSWORD='${{ secrets.FINDJOBNU_DB_PASSWORD }}'; END"
          /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${{ secrets.MSSQL_SA_PASSWORD }}" -d JobScraperDB -Q "IF NOT EXISTS (SELECT 1 FROM sys.database_principals WHERE name = 'findjobnusystem') BEGIN CREATE USER findjobnusystem FOR LOGIN findjobnusystem; EXEC sp_addrolemember 'db_owner', 'findjobnusystem'; END"

      - name: Restore (solution)
        run: dotnet restore Findjobnu.sln
        env:
          ConnectionStrings__FindjobnuConnection: Server=localhost,1433;Initial Catalog=JobScraperDB;Persist Security Info=False;User ID=findjobnusystem;Password=${{ secrets.FINDJOBNU_DB_PASSWORD }};MultipleActiveResultSets=False;Encrypt=False;TrustServerCertificate=True;Connection Timeout=30;

      - name: Build (solution)
        run: dotnet build Findjobnu.sln --no-restore

      - name: Test (solution)
        run: dotnet test Findjobnu.sln --no-build --verbosity normal
        env:
          ConnectionStrings__FindjobnuConnection: Server=localhost,1433;Initial Catalog=JobScraperDB;Persist Security Info=False;User ID=findjobnusystem;Password=${{ secrets.FINDJOBNU_DB_PASSWORD }};MultipleActiveResultSets=False;Encrypt=False;TrustServerCertificate=True;Connection Timeout=30;

      - name: Publish API for deployment
        run: dotnet publish findjobnuAPI/FindjobnuService.csproj -c Release -o publish/findjobnuAPI

      - name: Publish AuthService for deployment
        run: dotnet publish AuthService/AuthService.csproj -c Release -o publish/AuthService
                                                
      - name: Upload api build artifact
        uses: actions/upload-artifact@v4
        with:
          name: findjobnuAPI-build-artifact 
          path: publish/findjobnuAPI

      - name: Upload authservice build artifact
        uses: actions/upload-artifact@v4
        with:
          name: AuthService-build-artifact 
          path: publish/AuthService

  deploy:
    needs: build 
    runs-on: ubuntu-latest
    environment: Development 
    if: github.event_name == 'push'
    steps:
      - name: Download API build artifact
        uses: actions/download-artifact@v4
        with:
          name: findjobnuAPI-build-artifact
          path: ./findjobnuAPI-downloaded-artifact

      - name: Download Auth Service build artifact
        uses: actions/download-artifact@v4
        with:
          name: AuthService-build-artifact
          path: ./AuthService-downloaded-artifact

      - name: Deploy API application files via SCP
        uses: appleboy/scp-action@v0.1.7 
        with:
          host: ${{ vars.SERVER_NAME }} 
          username: ${{ vars.SERVER_USER }} 
          key: ${{ secrets.SERVER_ROOT_CERTIFICATE }} 
          source: "./findjobnuAPI-downloaded-artifact/*" 
          target: "/var/www/findjobnu/publish" 
          strip_components: 1
      
      - name: Deploy AuthService application files via SCP
        uses: appleboy/scp-action@v0.1.7 
        with:
          host: ${{ vars.SERVER_NAME }} 
          username: ${{ vars.SERVER_USER }} 
          key: ${{ secrets.SERVER_ROOT_CERTIFICATE }} 
          source: "./AuthService-downloaded-artifact/*" 
          target: "/var/www/findjobnu/auth/publish" 
          strip_components: 1

      - name: Execute post-deployment commands via SSH
        uses: appleboy/ssh-action@v1.0.3 
        with:
          host: ${{ vars.SERVER_NAME }}
          username: ${{ vars.SERVER_USER }}
          key: ${{ secrets.SERVER_ROOT_CERTIFICATE }}
          script: |
            echo "Deployment completed on $(date)"
            echo "Restarting findjobNu API service."
            sudo systemctl restart findjobnuapi.service
            echo "Restarting auth service service."
            sudo systemctl restart authapi.service
            echo "Listing API Status."
            sudo systemctl status findjobnuapi.service
            echo "Listing auth Status."
            sudo systemctl status authapi.service
